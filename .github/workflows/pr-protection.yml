# .github/workflows/pr-protection.yml
name: PR Protection

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

jobs:
  check-author:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Author
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const allowedUsers = ['cas8398']; // username GitHub
            const prAuthor = context.payload.pull_request.user.login;

            console.log(`PR Author: ${prAuthor}`);
            console.log(`Allowed users: ${allowedUsers.join(', ')}`);

            if (!allowedUsers.includes(prAuthor)) {
              // Auto close PR
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                state: 'closed'
              });
              
              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ðŸ‘‹ Hi @${prAuthor}!\n\n` +
                      `Terima kasih sudah berkontribusi! Namun, PR langsung ke branch \`main\` tidak diperbolehkan.\n\n` +
                      `Silakan buat PR ke branch \`develop\` terlebih dahulu:\n` +
                      `1. Close PR ini\n` +
                      `2. Ganti base branch menjadi \`develop\`\n` +
                      `3. Buat PR baru\n\n` +
                      `Untuk panduan lengkap, silakan baca [CONTRIBUTING.md](../CONTRIBUTING.md)\n\n` +
                      `JazakAllahu Khairan! ðŸ¤²`
              });
              
              // Fail the workflow
              core.setFailed(`PR to main branch only allowed from: ${allowedUsers.join(', ')}`);
            } else {
              console.log('âœ… PR author is authorized');
            }
